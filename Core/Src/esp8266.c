/**
	************************************************************
	************************************************************
	************************************************************
	*	ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½ 	esp8266.c
	*
	*	ï¿½ï¿½ï¿½ß£ï¿½ 		ï¿½Å¼ï¿½ï¿½ï¿½
	*
	*	ï¿½ï¿½ï¿½Ú£ï¿½ 		2017-05-08
	*
	*	ï¿½æ±¾ï¿½ï¿½ 		V1.0
	*
	*	Ëµï¿½ï¿½ï¿½ï¿½ 		ESP8266ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½ï¿½
	*
	*	ï¿½Þ¸Ä¼ï¿½Â¼ï¿½ï¿½
	************************************************************
	************************************************************
	************************************************************
**/

//ï¿½ï¿½Æ¬ï¿½ï¿½Í·ï¿½Ä¼ï¿½
#include "stm32f1xx_hal.h"

//ï¿½ï¿½ï¿½ï¿½ï¿½è±¸ï¿½ï¿½ï¿½ï¿½
#include "esp8266.h"

//Ó²ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
#include "usart.h"

//Cï¿½ï¿½
#include <string.h>
#include <stdio.h>


#define ESP8266_WIFI_INFO		"AT+CWJAP_CUR=\"E\",\"123456788\"\r\n"

#define ESP8266_ONENET_INFO		"AT+CIPSTART=\"TCP\",\"183.230.40.39\",6002\r\n"
//#define ESP8266_ONENET_INFO		"AT+CIPSTART=\"TCP\",\"183.230.40.33\",80\r\n"


unsigned char esp8266_buf[128];
unsigned short esp8266_cnt = 0, esp8266_cntPre = 0;


//==========================================================
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ£ï¿½	ESP8266_Clear
//
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü£ï¿½	ï¿½ï¿½Õ»ï¿½ï¿½ï¿
//
//	ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿	ï¿½ï¿½
//
//	ï¿½ï¿½ï¿½Ø²ï¿½ï¿½ï¿½ï¿½ï¿½	ï¿½ï¿½
//
//	Ëµï¿½ï¿½ï¿½ï¿½
//==========================================================
void ESP8266_Clear(void)
{

	memset(esp8266_buf, 0, sizeof(esp8266_buf));
	esp8266_cnt = 0;

}

//==========================================================
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ£ï¿½	ESP8266_WaitRecive
//
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü£ï¿½	ï¿½È´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿
//
//	ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿	ï¿½ï¿½
//
//	ï¿½ï¿½ï¿½Ø²ï¿½ï¿½ï¿½ï¿½ï¿½	REV_OK-ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿		REV_WAIT-ï¿½ï¿½ï¿½Õ³ï¿½Ê±Î´ï¿½ï¿½ï¿
//
//	Ëµï¿½ï¿½ï¿½ï¿½		Ñ­ï¿½ï¿½ï¿½ï¿½ï¿½Ã¼ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿
//==========================================================
_Bool ESP8266_WaitRecive(void)
{

	if(esp8266_cnt == 0) 							//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½Î0 ï¿½ï¿½Ëµï¿½ï¿½Ã»ï¿½Ð´ï¿½ï¿½Ú½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð£ï¿½ï¿½ï¿½ï¿½ï¿½Ö±ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		return REV_WAIT;
		
	if(esp8266_cnt == esp8266_cntPre)				//ï¿½ï¿½ï¿½ï¿½ï¿½Ò»ï¿½Îµï¿½Öµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¬ï¿½ï¿½ï¿½ï¿½Ëµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿
	{
		esp8266_cnt = 0;							//ï¿½ï¿½0ï¿½ï¿½ï¿½Õ¼ï¿½ï¿½ï¿½
			
		return REV_OK;								//ï¿½ï¿½ï¿½Ø½ï¿½ï¿½ï¿½ï¿½ï¿½É±ï¿½Ö
	}
		
	esp8266_cntPre = esp8266_cnt;					//ï¿½ï¿½Îªï¿½ï¿½Í¬
	return REV_WAIT;								//ï¿½ï¿½ï¿½Ø½ï¿½ï¿½ï¿½Î´ï¿½ï¿½É±ï¿½Ö

}

//==========================================================
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ£ï¿½	ESP8266_SendCmd
//
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü£ï¿½	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
//
//	ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿	cmdï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
//				resï¿½ï¿½ï¿½ï¿½Òªï¿½ï¿½ï¿½Ä·ï¿½ï¿½ï¿½Ö¸ï¿½ï¿½
//
//	ï¿½ï¿½ï¿½Ø²ï¿½ï¿½ï¿½ï¿½ï¿½	0-ï¿½É¹ï¿½	1-Ê§ï¿½ï¿½
//
//	Ëµï¿½ï¿½ï¿½ï¿½
//==========================================================
_Bool ESP8266_SendCmd(char *cmd, char *res)
{
	
	unsigned char timeOut = 200;

	HAL_UART_Transmit(&huart2, (unsigned char *)cmd, strlen((const char *)cmd), 0xff);
	while(timeOut--)
	{
		if(ESP8266_WaitRecive() == REV_OK)							//ï¿½ï¿½ï¿½ï¿½Õµï¿½ï¿½ï¿½ï¿½ï¿
		{
			if(strstr((const char *)esp8266_buf, res) != NULL)		//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ø¼ï¿½ï¿½ï¿
			{
				ESP8266_Clear();									//ï¿½ï¿½Õ»ï¿½ï¿½ï¿
				
				return 0;
			}
		}
		
		HAL_Delay(10);
	}
	
	return 1;

}

//==========================================================
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ£ï¿½	ESP8266_SendData
//
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü£ï¿½	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
//
//	ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿	dataï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
//				lenï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
//
//	ï¿½ï¿½ï¿½Ø²ï¿½ï¿½ï¿½ï¿½ï¿½	ï¿½ï¿½
//
//	Ëµï¿½ï¿½ï¿½ï¿½
//==========================================================
void ESP8266_SendData(unsigned char *data, unsigned short len)
{

	char cmdBuf[32];
	
	ESP8266_Clear();								//ï¿½ï¿½Õ½ï¿½ï¿½Õ»ï¿½ï¿½ï¿
	sprintf(cmdBuf, "AT+CIPSEND=%d\r\n", len);		//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	if(!ESP8266_SendCmd(cmdBuf, ">"))				//ï¿½Õµï¿½ï¿½ï¿½>ï¿½ï¿½Ê±ï¿½ï¿½ï¿½Ô·ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	{
		HAL_UART_Transmit(&huart2, data, len, 0xff);		//ï¿½ï¿½ï¿½ï¿½ï¿½è±¸ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	}

}

//==========================================================
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ£ï¿½	ESP8266_GetIPD
//
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü£ï¿½	ï¿½ï¿½È¡Æ½Ì¨ï¿½ï¿½ï¿½Øµï¿½ï¿½ï¿½ï¿½ï¿½
//
//	ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿	ï¿½È´ï¿½ï¿½ï¿½Ê±ï¿½ï¿½(ï¿½ï¿½ï¿½ï¿½10ms)
//
//	ï¿½ï¿½ï¿½Ø²ï¿½ï¿½ï¿½ï¿½ï¿½	Æ½Ì¨ï¿½ï¿½ï¿½Øµï¿½Ô­Ê¼ï¿½ï¿½ï¿½ï¿½
//
//	Ëµï¿½ï¿½ï¿½ï¿½		ï¿½ï¿½Í¬ï¿½ï¿½ï¿½ï¿½ï¿½è±¸ï¿½ï¿½ï¿½ØµÄ¸ï¿½Ê½ï¿½ï¿½Í¬ï¿½ï¿½ï¿½ï¿½ÒªÈ¥ï¿½ï¿½ï¿½ï¿½
//				ï¿½ï¿½ESP8266ï¿½Ä·ï¿½ï¿½Ø¸ï¿½Ê½Îª	"+IPD,x:yyy"	xï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ý³ï¿½ï¿½È£ï¿½yyyï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
//==========================================================
unsigned char *ESP8266_GetIPD(unsigned short timeOut)
{

	char *ptrIPD = NULL;
	
	do
	{
		if(ESP8266_WaitRecive() == REV_OK)								//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
		{
			ptrIPD = strstr((char *)esp8266_buf, "IPD,");				//ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½IPDï¿½ï¿½Í·
			if(ptrIPD == NULL)											//ï¿½ï¿½ï¿½Ã»ï¿½Òµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½IPDÍ·ï¿½ï¿½ï¿½Ó³Ù£ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Òªï¿½È´ï¿½Ò»ï¿½á£¬ï¿½ï¿½ï¿½ï¿½ï¿½á³¬ï¿½ï¿½ï¿½è¶¨ï¿½ï¿½Ê±ï¿½ï¿½
			{
				//UsartPrintf(USART_DEBUG, "\"IPD\" not found\r\n");
			}
			else
			{
				ptrIPD = strchr(ptrIPD, ':');							//ï¿½Òµï¿½':'
				if(ptrIPD != NULL)
				{
					ptrIPD++;
					return (unsigned char *)(ptrIPD);
				}
				else
					return NULL;
				
			}
		}
		
		HAL_Delay(5);													//ï¿½ï¿½Ê±ï¿½È´ï¿½
	} while(timeOut--);
	
	return NULL;														//ï¿½ï¿½Ê±ï¿½ï¿½Î´ï¿½Òµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ø¿ï¿½Ö¸ï¿½ï¿½

}

//==========================================================
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ£ï¿½	ESP8266_Init
//
//	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü£ï¿½	ï¿½ï¿½Ê¼ï¿½ï¿½ESP8266
//
//	ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿	ï¿½ï¿½
//
//	ï¿½ï¿½ï¿½Ø²ï¿½ï¿½ï¿½ï¿½ï¿½	ï¿½ï¿½
//
//	Ëµï¿½ï¿½ï¿½ï¿½
//==========================================================
void ESP8266_Init(void)
{

	
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_14, 0);
	HAL_Delay(250);
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_14, 1);
	HAL_Delay(500);
	
	ESP8266_Clear();
	

	printf("1. AT\r\n");
	while(ESP8266_SendCmd("AT\r\n", "OK"))
		HAL_Delay(500);
	


	printf("2. CWMODE\r\n");
	while(ESP8266_SendCmd("AT+CWMODE_CUR=1\r\n", "OK"))
		HAL_Delay(500);
	

	printf("3. AT+CWDHCP\r\n");
	while(ESP8266_SendCmd("AT+CWDHCP_CUR=1,1\r\n", "OK"))
		HAL_Delay(500);
	
	printf("4. CWJAP\r\n");
	while(ESP8266_SendCmd(ESP8266_WIFI_INFO, "GOT IP"))
		HAL_Delay(500);
	
	printf("5. CIPSTART\r\n");
	while(ESP8266_SendCmd(ESP8266_ONENET_INFO, "CONNECT"))
		HAL_Delay(500);
	
	printf("6. ESP8266 Init OK\r\n");

}

